program dfdc_test
    use api
    use m_dfdcsubs, only : gengeom

    use m_aero_old, only : clcdcm
    use i_dfdc, only : dtr

    integer, parameter :: &
            n_rotors = 1, &
            n_wake = 20, &
            n_polars(n_rotors) = (/ 1 /), &
            n_polar_points(sum(n_polars)) = (/ 105 /), &
            n_blades(n_rotors) = (/ 8 /), &
            n_prdef(n_rotors) = (/ 11 /), &
            n_stations(n_rotors) = (/ 10 /), &
            n_cb = 93, &
            n_duct = 100
    real :: &
            vinf = 35.0, &
            vref = 50.0, &
            rpms(n_rotors) = (/ 4100.0 /), &
            rho = 1.226, &
            vso = 340.0, &
            rmu = 0.178E-04, &
            alt = 0.0, &
            xdwake = 0.8, &
            xi_polars(sum(n_polars)) = (/ 0.0 /), &
            xdisk(n_rotors) = (/ 0.2456 /), &
            rotorgeom(sum(n_stations), 3) = reshape((/&
                ! r [m]
                0.22352, 0.26413, 0.30475, 0.34536, 0.38597, &
                0.42658, 0.46719, 0.50780, 0.54842, 0.58903, &
                ! c [m]
                0.95599E-01, 0.94257E-01, 0.91444E-01, 0.88965E-01, 0.86009E-01, &
                0.81300E-01, 0.74523E-01, 0.68257E-01, 0.63524E-01, 0.59241E-01, &
                ! beta [deg]
                40.439, 35.680, 31.256, 26.994, 23.181, &
                20.010, 17.419, 15.145, 13.011, 10.986/), (/ sum(n_stations), 3 /)), &
            cbgeom(n_cb, 2) = reshape((/&
                ! x
                +1.041080, +1.029229, +1.014810, +0.999134, +0.983012, +0.966780, +0.950549, +0.934355, &
                +0.918207, +0.902110, +0.886066, +0.870073, +0.854125, +0.838200, +0.821451, +0.804611, &
                +0.787592, +0.770310, +0.752739, +0.734855, +0.716640, +0.698073, +0.679130, +0.659787, &
                +0.640018, +0.619820, +0.599253, +0.578384, +0.557205, +0.535696, +0.513834, +0.491614, &
                +0.469223, +0.446968, +0.424876, +0.402768, +0.380538, +0.358171, +0.335666, +0.313070, &
                +0.290490, +0.268010, +0.245600, +0.223587, +0.201487, +0.179457, +0.157601, +0.135943, &
                +0.114507, +0.093751, +0.074288, +0.055545, +0.036922, +0.018263, -0.000419, -0.018962, &
                -0.037267, -0.055381, -0.073324, -0.091101, -0.108704, -0.126105, -0.143275, -0.160209, &
                -0.176911, -0.193400, -0.209749, -0.226065, -0.242391, -0.258723, -0.275008, -0.291039, &
                -0.306312, -0.320563, -0.333968, -0.346842, -0.359435, -0.371791, -0.383791, -0.395156, &
                -0.405738, -0.415531, -0.424556, -0.432826, -0.440331, -0.447055, -0.452934, -0.457855, &
                -0.461806, -0.464856, -0.467094, -0.468525, -0.469000, &
                ! y
                +0.122950, +0.127660, +0.133205, +0.139003, +0.144722, +0.150230, +0.155483, +0.160462, &
                +0.165157, +0.169565, +0.173678, +0.177494, +0.181009, +0.184223, +0.187279, +0.190018, &
                +0.192452, +0.194598, +0.196472, +0.198087, +0.199457, +0.200598, +0.201525, +0.202256, &
                +0.202813, +0.203219, +0.203495, +0.203658, +0.203723, +0.203707, +0.203630, +0.203513, &
                +0.203381, +0.203260, +0.203173, +0.203126, +0.203111, +0.203119, +0.203142, +0.203173, &
                +0.203201, +0.203218, +0.203216, +0.203198, +0.203173, +0.203155, +0.203154, +0.203181, &
                +0.203245, +0.203296, +0.203214, +0.202928, +0.202432, +0.201733, +0.200838, +0.199756, &
                +0.198474, +0.196980, +0.195267, +0.193329, +0.191160, +0.188759, +0.186121, +0.183237, &
                +0.180099, +0.176696, +0.173004, +0.169001, +0.164683, +0.160059, +0.155148, +0.150029, &
                +0.144853, +0.139641, +0.134282, +0.128619, +0.122564, +0.116114, +0.109353, +0.102433, &
                +0.095404, +0.088252, +0.080961, +0.073525, +0.065960, +0.058308, +0.050670, +0.043111, &
                +0.035555, +0.027804, +0.019625, +0.010657, +0.000000/), (/n_cb, 2/)), &
            ductgeom(n_duct, 2) = reshape((/&
                ! x
                0.838200, 0.825573, 0.808525, 0.788544, 0.766880, 0.745100, 0.725664, 0.707540, 0.688648, 0.670663, &
                0.652814, 0.634845, 0.617884, 0.599463, 0.578979, 0.558940, 0.539777, 0.522106, 0.506815, 0.492037, &
                0.475503, 0.456506, 0.435899, 0.413231, 0.389456, 0.364841, 0.339838, 0.314717, 0.289744, 0.265167, &
                0.241398, 0.218986, 0.198210, 0.179597, 0.162993, 0.146013, 0.127006, 0.107877, 0.091255, 0.076499, &
                0.062885, 0.049963, 0.038183, 0.028667, 0.021014, 0.014657, 0.009353, 0.005147, 0.002101, 0.000323, &
                0.000115, 0.001628, 0.004183, 0.007539, 0.013316, 0.019744, 0.027062, 0.035657, 0.045776, 0.057413, &
                0.070478, 0.084469, 0.098977, 0.113960, 0.129536, 0.146156, 0.164553, 0.184643, 0.204542, 0.224230, &
                0.245600, 0.267284, 0.289933, 0.313208, 0.336108, 0.358372, 0.378981, 0.398167, 0.414950, 0.429908, &
                0.444548, 0.459653, 0.475709, 0.493422, 0.513612, 0.535941, 0.559181, 0.582713, 0.606403, 0.630141, &
                0.653908, 0.677651, 0.701306, 0.724778, 0.747880, 0.770318, 0.791339, 0.810230, 0.826230, 0.838200, &
                ! y
                0.689000, 0.691883, 0.695632, 0.699816, 0.704149, 0.708406, 0.712002, 0.714868, 0.717393, 0.719993, &
                0.723202, 0.726532, 0.729104, 0.731250, 0.733427, 0.735765, 0.738333, 0.740783, 0.742385, 0.743033, &
                0.742940, 0.742592, 0.742561, 0.742669, 0.742667, 0.742643, 0.742649, 0.742647, 0.742653, 0.742668, &
                0.742616, 0.742589, 0.742794, 0.742903, 0.742444, 0.741241, 0.739418, 0.737447, 0.735386, 0.732983, &
                0.730074, 0.726603, 0.723046, 0.719652, 0.715852, 0.711334, 0.706229, 0.700686, 0.694611, 0.688161, &
                0.681531, 0.674609, 0.667249, 0.660330, 0.654258, 0.648098, 0.642782, 0.638138, 0.633794, 0.629577, &
                0.625512, 0.621781, 0.618600, 0.615996, 0.613963, 0.612433, 0.611221, 0.610181, 0.609477, 0.609246, &
                0.609333, 0.609409, 0.609377, 0.609342, 0.609374, 0.609447, 0.609345, 0.609104, 0.609234, 0.609989, &
                0.611370, 0.613358, 0.615968, 0.619252, 0.623230, 0.627705, 0.632365, 0.637066, 0.641800, 0.646548, &
                0.651300, 0.656048, 0.660782, 0.665490, 0.670109, 0.674548, 0.678761, 0.682728, 0.686257, 0.689000 &
                /), (/n_duct, 2/))
    logical(c_bool), parameter :: lwkrlx = .false.

    real :: polardata(sum(n_polar_points), 4)
    real :: &
            a0 = -1.68 * dtr, &
            dclda = 6.28, &
            clmax = 1.15, &
            clmin = -0.2, &
            dclda_stall = 0.1, &
            dcl_stall = 0.1, &
            cmcon = -0.1, &
            mcrit = 0.8, &
            cdmin = 0.62e-2, &
            cldmin = 0.2039, &
            dcdcl2 = 0.111e-1, &
            reref = 0.3e6, &
            rexp = -0.4, &
            w = 0.0, &
            rey = 0.3e6, &
            secsig = 0.0, &
            segstagr = 0.0, &
            toc = 0.1, &
            dcdcl2s = 0.020
    real, parameter :: a_range(2) = (/ -25.0, 25.0 /)
    real :: cdrag, cd_alf, cd_rey, cd_w, &
            & clift, cl_alf, cl_w, &
            & cmom, cm_al, cm_w
    logical :: stallf

    real :: a
    integer :: i
    do i = 1, n_polar_points(1)
        polardata(i, 1) = (a_range(1) + real(i) * (a_range(2) - a_range(1)) / real(n_polar_points(1))) * dtr
        call clcdcm(&
                polardata(i, 1), w, rey, vso, secsig, segstagr, &
                polardata(i, 2), cl_alf, cl_w, &
                stallf, polardata(i, 3), cd_alf, cd_w, cd_rey, &
                polardata(i, 4), cm_al, cm_w, &
                a0, clmax, clmin, dclda, dclda_stall, dcl_stall, &
                cdmin, cldmin, dcdcl2, cmcon, mcrit, reref, rexp, toc, dcdcl2s)
    end do

    call init
    call set_case(&
            n_rotors, &
            vinf, vref, rpms, &
            rho, vso, rmu, alt, &
            xdwake, n_wake, lwkrlx, &
            n_polars, n_polar_points, xi_polars, polardata, &
            xdisk, n_blades, n_prdef, n_stations, rotorgeom, &
            n_cb, cbgeom, &
            n_duct, ductgeom)
    call oper
end program dfdc_test
